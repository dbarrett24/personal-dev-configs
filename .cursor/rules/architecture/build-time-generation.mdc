---
description: Build-time code generation patterns using tsup onSuccess hooks
globs: ["**/tsup.config.ts", "**/tsup.config.js"]
---

# Build-Time Code Generation

## When to Use Build-Time Generation

Use build-time code generation when you need to:
- Generate files from TypeScript definitions (e.g., CSS from brand themes)
- Transform data at build time (e.g., aggregate multiple sources)
- Create derived artifacts that should be version-controlled (optional) or ephemeral
- Ensure consistency between source code and generated output

**Examples in this codebase**:
- Theme-system: Generates CSS files from TypeScript brand definitions (DS-15b)
- (Future): Generate icon manifests from SVG sources
- (Future): Generate type definitions from JSON schemas

## Two Build-Time Generation Approaches

Build-time generation can happen in two distinct ways, depending on what you're generating and where it should live:

| Approach | Used For | Output Location | Committed to Git | Run Via | Example |
|----------|----------|----------------|------------------|---------|---------|
| **tsup onSuccess** | Build artifacts | `dist/css/`, `dist/json/` | No (gitignored) | tsup hook | Theme CSS files (DS-15b) |
| **Standalone Script** | Source code | `src/generatedIcons/`, `src/types/` | Yes | npm script ‚Üí tsup | Icon components (DS-18) |

### When to Use Each Approach

**Use tsup onSuccess** when:
- Generating artifacts **from already-built code** (dist/ ‚Üí dist/)
- Output is consumed directly by external consumers
- Generated files are ephemeral (fast to rebuild)
- Example: CSS files derived from TypeScript theme definitions

**Use Standalone Script** when:
- Generating **source code** that TypeScript needs to compile
- Generated files should be **committed to git**
- Generation happens **before** TypeScript compilation
- Example: React components from SVG library, types from JSON schemas

---

## Pattern: tsup onSuccess Hook

### Basic Setup

```typescript
// shared-configs/theme-system/tsup.config.ts
import { defineConfig } from 'tsup';

export default defineConfig({
    entry: ['src/index.ts'],
    format: ['esm', 'cjs'],
    dts: true,
    clean: true,
    
    // Build-time generation hook
    onSuccess: async () => {
        console.log('üî® Generating derived artifacts...');
        
        // Import source data (must be built first!)
        const { data } = await import('./dist/source.mjs');
        
        // Generate files
        await generateFiles(data);
        
        console.log('‚úÖ Generation complete');
    },
});
```

### Theme CSS Generation Pattern

**Use case**: Generate brand CSS files from TypeScript theme definitions

```typescript
// tsup.config.ts
import { defineConfig } from 'tsup';

export default defineConfig({
    entry: [
        'src/index.ts',
        'src/themes/generateCSSVars.ts',  // Must be built BEFORE onSuccess
        'src/themes/writeToCSSFile.ts',
    ],
    format: ['esm', 'cjs'],
    dts: true,
    
    onSuccess: async () => {
        // Import utilities and brand definitions
        const { generateCSSVars, makeColorCSSVarsFromObject } = 
            await import('./dist/themes/generateCSSVars.mjs');
        const { writeToCSSFile } = 
            await import('./dist/themes/writeToCSSFile.mjs');
        
        // Import brand 1
        const { nonColorVariables: Basketball, colorAliases: BasketballAliases } = 
            await import('./dist/themes/BasketballTraining.mjs');
        
        // Generate CSS for brand 1
        writeToCSSFile(
            generateCSSVars({
                ...Basketball,
                ...makeColorCSSVarsFromObject(BasketballAliases),
            }, 'brand-basketball'),  // CSS class name
            'dist/css/BasketballTraining.css'
        );
        
        // Repeat for other brands...
        
        console.log('‚úÖ Generated theme CSS files in dist/css/');
    },
});
```

### Key Principles

1. **Dependencies Must Be Built First**:
   ```typescript
   entry: [
       'src/index.ts',
       'src/themes/generateCSSVars.ts',  // ‚Üê Must include generator utilities
       'src/themes/writeToCSSFile.ts',
   ],
   ```

2. **Import from dist/, Not src/**:
   ```typescript
   // ‚úÖ CORRECT - imports from built files
   const { util } = await import('./dist/util.mjs');
   
   // ‚ùå WRONG - imports from source (not built yet)
   const { util } = await import('./src/util.ts');
   ```

3. **Use Dynamic Imports**:
   ```typescript
   // ‚úÖ CORRECT - async import in onSuccess
   onSuccess: async () => {
       const { data } = await import('./dist/source.mjs');
   }
   
   // ‚ùå WRONG - static import at top level (runs before build)
   import { data } from './dist/source.mjs';  // File doesn't exist yet!
   ```

4. **Handle Errors Gracefully**:
   ```typescript
   onSuccess: async () => {
       try {
           await generateFiles();
           console.log('‚úÖ Generation complete');
       } catch (error) {
           console.error('‚ùå Generation failed:', error);
           throw error;  // Fail the build
       }
   }
   ```

## File Writer Utility Pattern

Create a reusable file writer utility:

```typescript
// src/themes/writeToCSSFile.ts
import { writeFileSync } from 'node:fs';
import { resolve } from 'node:path';

export const writeToCSSFile = (content: string, filePath: string): void => {
    const fullPath = resolve(process.cwd(), filePath);
    
    // Use sync write in onSuccess (async causes issues)
    writeFileSync(fullPath, content, 'utf-8');
    
    console.log(`‚úÖ Wrote ${filePath}`);
};
```

## CSS Generator Pattern

```typescript
// src/themes/generateCSSVars.ts
export const generateCSSVars = (
    variables: Record<string, string>,
    className: string
): string => {
    const entries = Object.entries(variables);
    
    // Generate class-based selector
    const classBlock = `.${className} {\n${
        entries.map(([key, value]) => `    ${key}: ${value};`).join('\n')
    }\n}\n\n`;
    
    // Generate :root fallback
    const rootBlock = `:root {\n${
        entries.map(([key, value]) => `    ${key}: ${value};`).join('\n')
    }\n}\n`;
    
    return classBlock + rootBlock;
};
```

## Package Exports for Generated Files

Update `package.json` to export generated files:

```json
{
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./css/BasketballTraining.css": "./dist/css/BasketballTraining.css",
    "./css/ProfessionalBrand.css": "./dist/css/ProfessionalBrand.css"
  },
  "files": [
    "dist/**/*"
  ]
}
```

---

## Pattern: Standalone Build Scripts (Pre-Compile Generation)

### Overview

Standalone build scripts run **before** tsup compilation and generate source code in `src/` rather than build artifacts in `dist/`.

### Icon Generation Pattern (DS-18)

**Use Case**: Generate React components from third-party SVG library

```typescript
// scripts/copy-phosphor-icons.ts
import { writeFileSync } from 'node:fs';
import { resolve } from 'node:path';

// Read source data from node_modules
const iconData = extractIconsFromLibrary();

// Generate React component files
iconData.forEach(icon => {
    const componentCode = generateIconComponent(icon);
    const outputPath = resolve(__dirname, `../src/Icons/generatedIcons/${icon.name}.tsx`);
    writeFileSync(outputPath, componentCode, 'utf-8');
});

// Generate barrel export
const indexCode = iconData.map(icon => 
    `export { ${icon.name} } from './generatedIcons/${icon.name}';`
).join('\n');
writeFileSync(resolve(__dirname, '../src/Icons/index.ts'), indexCode, 'utf-8');

console.log(`‚úÖ Generated ${iconData.length} icon components`);
```

**package.json Integration**:

```json
{
  "scripts": {
    "build-icons": "tsx scripts/copy-phosphor-icons.ts",
    "build": "pnpm build-icons && tsup",
    "dev": "pnpm build-icons && tsup --watch"
  },
  "devDependencies": {
    "tsx": "^4.7.0"  // Simpler than ts-node, no config needed
  }
}
```

### Key Differences from tsup onSuccess

**1. Runs BEFORE tsup** (not inside):
```bash
pnpm build-icons  # Generates src/Icons/generatedIcons/*.tsx
tsup              # Compiles the generated files
```

**2. Generates source files** (src/), not build artifacts (dist/):
```
src/
‚îî‚îÄ‚îÄ Icons/
    ‚îú‚îÄ‚îÄ IconBase.tsx          (hand-written)
    ‚îú‚îÄ‚îÄ index.ts              (generated by script)
    ‚îî‚îÄ‚îÄ generatedIcons/       (generated by script)
        ‚îú‚îÄ‚îÄ Archive.tsx       (generated)
        ‚îú‚îÄ‚îÄ HeartStraight.tsx (generated)
        ‚îî‚îÄ‚îÄ ...
```

**3. Committed to git** (enables code review, works without dependency at runtime):
```gitignore
# dist/ is gitignored
dist/

# Generated source files are NOT gitignored
# src/Icons/generatedIcons/*.tsx  ‚Üê These ARE committed
```

**4. Must run on clean install**:
```bash
# After git clone, before first build:
pnpm install       # Installs dependencies
pnpm build-icons   # Generates source files (if not committed)
pnpm build         # Compiles everything
```

### Why Generate Source Code vs. Dist Artifacts?

**Generate in src/** when:
- Third-party library format is incompatible (need to transform)
- Generated code needs type-checking by TypeScript compiler
- Want to review generated code in PRs (git diff)
- Generated code is "implementation detail" consumers don't see

**Generate in dist/** when:
- Deriving artifacts from built code (CSS from TS themes)
- Consumers import the generated file directly (CSS, JSON)
- Generated code is ephemeral (rebuilds are fast)

### Build Script Best Practices

**1. Use tsx instead of ts-node** (simpler, no config):
```bash
npm install -D tsx
# Run scripts with: tsx scripts/my-script.ts
```

**2. Add success logging**:
```typescript
console.log(`‚úÖ Generated ${count} files`);
```

**3. Handle errors gracefully**:
```typescript
try {
    generateFiles();
} catch (error) {
    console.error('‚ùå Generation failed:', error);
    process.exit(1);  // Fail the build
}
```

**4. Format generated code during generation** (recommended):

**Option A: Format during generation** (recommended for production)

```typescript
import prettier from 'prettier';
import { readFileSync } from 'node:fs';

// Load prettier config
const prettierConfig = JSON.parse(
    readFileSync('.prettierrc', 'utf-8')
);

const generatedCode = `
export const MyComponent = () => {
    return <div>Hello</div>;
};
`;

const formatted = await prettier.format(generatedCode, {
    parser: 'typescript',
    ...prettierConfig,
});

writeFileSync(outputPath, formatted, 'utf-8');
```

**Benefits**:
- ‚úÖ No verification failures from unformatted generated code
- ‚úÖ Clean git diffs (consistent formatting)
- ‚úÖ Build artifacts are ready to use

**Tradeoffs**:
- Requires Prettier as build script dependency
- Slightly slower generation

**Option B: Let lint-fix handle it** (simpler for prototypes)

```typescript
// Just write the code, don't format
writeFileSync(outputPath, generatedCode, 'utf-8');

// Later, run:
// pnpm lint-fix
```

**Benefits**:
- ‚úÖ Simpler build script
- ‚úÖ No Prettier dependency in build script

**Tradeoffs**:
- ‚ùå Causes verification failures (unformatted code)
- ‚ùå Requires manual intervention
- ‚ùå Clutters git diffs with formatting changes

**Recommendation**: Use Option A for production code generation. Option B is acceptable for prototypes or one-time migrations.

**DS-18 Experience**: Generated icons were unformatted, requiring manual `pnpm lint-fix` during verification. Would have been cleaner to format during generation.

### Rebuild Triggers

When using standalone build scripts, rebuild is needed when:
- ‚úÖ Source dependency changes: `@phosphor-icons/react` version updated
- ‚úÖ Input list changes: `importedIcons.ts` modified
- ‚úÖ Build script changes: `copy-phosphor-icons.ts` modified
- ‚ùå Wrapper component changes: No regeneration needed (generated files import the wrapper)

### Example: Type Generation from JSON Schema

```typescript
// scripts/generate-types.ts
import { compile } from 'json-schema-to-typescript';
import { writeFileSync } from 'node:fs';

const schema = require('../data/api-schema.json');

compile(schema, 'APITypes').then(ts => {
    writeFileSync('src/types/api.generated.ts', ts, 'utf-8');
    console.log('‚úÖ Generated TypeScript types from JSON schema');
});
```

```json
// package.json
{
  "scripts": {
    "generate-types": "tsx scripts/generate-types.ts",
    "build": "pnpm generate-types && tsup"
  }
}
```

### Comparison Summary

```
Theme CSS Generation (DS-15b):
    TypeScript ‚Üí tsup ‚Üí dist/*.mjs ‚Üí onSuccess ‚Üí dist/css/*.css
    (Generates dist/ artifacts from dist/ source)

Icon Generation (DS-18):
    node_modules ‚Üí standalone script ‚Üí src/generatedIcons/*.tsx ‚Üí tsup ‚Üí dist/*.js
    (Generates src/ source from node_modules, then compiles normally)
```

---

## Troubleshooting

### Issue: "Cannot find module './dist/...'"

**Cause**: Trying to import before file is built

**Fix**: Add file to `entry` array:
```typescript
entry: ['src/index.ts', 'src/missing-file.ts'],
```

### Issue: Generated files not in git

**Decision**: Generated files in `dist/` are typically NOT committed (gitignored). They're ephemeral build artifacts.

**Exception**: If consumers need the files without building (e.g., CSS for CDN), commit them.

### Issue: onSuccess doesn't run

**Cause**: Build failed before reaching onSuccess

**Fix**: Check for TypeScript errors, ensure all dependencies exist

### Issue: Import path extensions

**Cause**: Must use `.mjs` extension for ESM imports in Node.js

**Fix**: 
```typescript
// ‚úÖ CORRECT
await import('./dist/file.mjs');

// ‚ùå WRONG
await import('./dist/file');
```

## Related Patterns

- **Peer Dependencies**: `.cursor/rules/architecture/monorepo-builds.mdc`
- **Theme Architecture**: `.cursor/rules/architecture/theming.mdc`
- **Package Exports**: `.cursor/rules/documentation/patterns.mdc`
- **Test Coverage for Generated Code**: `.cursor/rules/quality/testing.mdc`

---

**Last Updated**: 2026-02-12 (DS-18 standalone script pattern added)
