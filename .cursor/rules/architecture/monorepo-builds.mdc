---
description: Understanding build dependencies in pnpm monorepo - when to rebuild packages after source changes
globs: ["**/*.ts", "**/*.tsx", "**/*.css", "**/*.json"]
---

# Monorepo Build Dependencies

This project is a pnpm monorepo with workspace packages. Understanding build dependencies is critical.

## Build Artifacts vs Source Files (Updated 2026-02-11)

### Key Distinction
- **Source files**: Located in `src/` directories (e.g., `src/themes/BasketballTraining.ts`)
- **Build artifacts**: Generated in `dist/` directories (e.g., `dist/css/BasketballTraining.css`)
- **Imports reference build artifacts**: When package.json exports `"./css/BasketballTraining.css": "./dist/css/BasketballTraining.css"`, consumers import from dist/

### Theme CSS Build Flow

**OLD FLOW** (Pre-DS-15b, DEPRECATED):
```
brand-libraries/basketball-training-ui/src/theme/styles.css (source)
    ↓ pnpm build (copies CSS)
brand-libraries/basketball-training-ui/dist/theme/styles.css (artifact)
    ↓ consumer imports
apps/docs imports from: '@dbarrett24/basketball-training-ui/theme'
```

**NEW FLOW** (DS-15b+):
```
theme-system/src/themes/BasketballTraining.ts (TypeScript definition)
    ↓ pnpm build (tsup onSuccess hook generates CSS)
theme-system/dist/css/BasketballTraining.css (generated artifact)
    ↓ consumer imports
apps/docs imports from: '@dbarrett24/theme-system/css/BasketballTraining.css'
```

### When Builds Are Required (Updated)

**Theme changes require theme-system rebuild**:
- Modify `theme-system/src/themes/*.ts` → Rebuild theme-system
- Modify `theme-system/src/tailwind/*.ts` → Rebuild theme-system
- Modify `theme-system/src/utils/wrapVar.ts` or `color.ts` → Rebuild theme-system

**Brand component changes require brand rebuild**:
- Modify `brand-libraries/*/src/components/*.tsx` → Rebuild that brand
- ❌ NO CSS rebuild needed (CSS comes from theme-system)

**General rule**:
- Any file in `src/` directory → Rebuild the package containing it
- `package.json` changes → Rebuild
- `tsconfig.json` or `tsup.config.ts` changes → Rebuild

**Example**:
```bash
# You modified: theme-system/src/themes/BasketballTraining.ts
# Before testing, run:
cd shared-configs/theme-system && pnpm build
# This regenerates dist/css/BasketballTraining.css
```

## Cross-Package Dependencies (Updated 2026-02-11)

### Dependency Chain
```
theme-system (generates brand CSS at build time)
    ↓
brand-libraries/* (components only, import theme-system CSS)
    ↓
core-components (styled components)
    ↓
templates/* (applications)
```

### Rebuild Strategy

**When changing theme-system**:
```bash
# Rebuild theme-system (generates CSS in dist/css/)
pnpm build:theme

# Brand libraries DON'T need rebuild (they don't build theme CSS)
# Just restart consuming apps to pick up new CSS

# Core components may need rebuild if API changed
pnpm build:core
```

**When changing brand-libraries**:
```bash
# Rebuild the specific brand (components only, no CSS)
pnpm --filter @dbarrett24/basketball-training-ui build

# Restart Storybook to pick up new component dist files
pnpm storybook:core
```

**When changing theme definitions (TypeScript)**:
```bash
# Modify: theme-system/src/themes/BasketballTraining.ts
# Rebuild: theme-system (triggers CSS regeneration)
pnpm build:theme

# Restart: All consuming apps/Storybook
pnpm storybook:core
```

**When changing core-components**:
```bash
pnpm build:core
# Dependent brand libraries may need rebuilding if they import from core
```

## Storybook and Build Artifacts

**Critical**: Storybook imports from build artifacts (dist/), not source files.

When you modify CSS/JS source files:
1. Rebuild the package containing those files
2. Restart Storybook (or hard refresh browser with Cmd+Shift+R)
3. Verify changes appear in Storybook

**Common Issue**:
```
❌ Modified: src/theme/styles.css
❌ Tested: Storybook immediately (no rebuild)
❌ Result: Storybook shows old styles (imports dist/theme/styles.css)

✅ Modified: src/theme/styles.css
✅ Rebuilt: pnpm build
✅ Tested: Restarted Storybook
✅ Result: Storybook shows new styles
```

## New Package Checklist

When creating new packages in the monorepo:

**Package Structure**:
- [ ] `package.json` with proper name, version, scripts, exports
- [ ] `tsconfig.json` extending appropriate workspace config
- [ ] `jest.config.js` or `vitest.config.ts` (if package has tests)
- [ ] **Test setup file** (if required by base config - check `setupFilesAfterEnv`)
- [ ] `src/` directory with proper structure (components, utils, etc.)
- [ ] `README.md` with package purpose and usage examples

**Validation Steps**:
- [ ] Run tests: `pnpm test` (should pass or skip gracefully)
- [ ] Check JSX transform alignment (TypeScript config vs test config)
- [ ] Build package: `pnpm build` (should complete without errors)
- [ ] Verify exports work: Try importing from another package

**Common Gotchas**:
- Missing `testing/setupTests.ts` when base config expects it
- React import requirements mismatch between TypeScript and test configs
- Missing dependencies in `package.json` that were hoisted

## Verification Checklist

Before testing changes that span multiple packages:

- [ ] Identified all packages with modified source files
- [ ] Rebuilt each modified package in dependency order
- [ ] Restarted any dev servers (Storybook, Next.js, Vite)
- [ ] Hard refreshed browser if styles seem stale

## Workspace Scripts

Use root-level scripts for convenience:
- `pnpm build` - Builds all packages (via Turbo)
- `pnpm build:theme` - Build theme-system only
- `pnpm build:core` - Build core-components only
- `pnpm build:basketball` - Build basketball-training-ui only
- `pnpm build:professional` - Build professional-brand-ui only

## Package Export Patterns for Config Files

When creating shared config packages (Tailwind, ESLint, tsup, etc.), follow these patterns:

### Exporting Config Files

Config files need special export paths in `package.json`:

```json
{
  "name": "@dbarrett24/theme-system",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./tailwind.config": {
      "import": "./tailwind.config.js",
      "require": "./tailwind.config.js"
    },
    "./tailwind.config.js": {
      "import": "./tailwind.config.js",
      "require": "./tailwind.config.js"
    },
    "./tailwind-plugin": {
      "import": "./dist/tailwind-plugin.mjs",
      "require": "./dist/tailwind-plugin.js",
      "types": "./dist/tailwind-plugin.d.ts"
    },
    "./theme": "./dist/theme/styles.css"
  }
}
```

**Key Patterns**:
1. **Config files** (`.js`): Export both with and without extension
   - `"./tailwind.config"` AND `"./tailwind.config.js"`
   - Some tools add `.js`, some don't
   
2. **CSS files**: Export directly (not built)
   - `"./theme": "./dist/theme/styles.css"`
   - Or source: `"./theme": "./src/theme/styles.css"`
   
3. **Built modules**: Export both ESM and CJS
   - `"import": "./dist/file.mjs"`
   - `"require": "./dist/file.js"`

### Common Export Errors

**Error**: `Package subpath './tailwind.config' is not defined by "exports"`

**Fix**: Add both paths to exports:
```json
"./tailwind.config": { /* ... */ },
"./tailwind.config.js": { /* ... */ }
```

**Error**: `Cannot find module './dist/tailwind-plugin'`

**Fix**: Ensure `tsup.config.ts` includes the file in `entry` array:
```typescript
export default defineConfig({
    entry: ['src/index.ts', 'src/tailwind-plugin.ts'],
    // ...
});
```
