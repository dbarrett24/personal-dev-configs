---
description: CSS theming architecture patterns for multi-brand support
globs: ["**/theme/**/*.css", "**/*.css"]
---

# CSS Theming Architecture

Patterns for implementing multi-brand theming.

## Architecture Overview (Updated 2026-02-11)

### Centralized CSS Generation Pattern

**CURRENT ARCHITECTURE** (DS-15b):
- ✅ Theme-system generates ALL brand CSS at build time
- ✅ Brand libraries contain ONLY components (no CSS files)
- ✅ Consumer apps import CSS from `@dbarrett24/theme-system/css/*.css`

```
theme-system/
├── src/
│   ├── themes/
│   │   ├── BasketballTraining.ts    # TypeScript brand definition
│   │   ├── ProfessionalBrand.ts
│   │   ├── Default.ts
│   │   ├── generateCSSVars.ts       # TS → CSS converter
│   │   └── writeToCSSFile.ts        # File writer
│   └── utils/
│       └── color.ts                  # tinycolor2 color generation
├── dist/css/                          # Generated at build time
│   ├── BasketballTraining.css        # .brand-basketball { ... } + :root fallback
│   ├── ProfessionalBrand.css
│   └── Default.css
└── tsup.config.ts                     # onSuccess hook generates CSS

brand-libraries/basketball-training-ui/
├── src/components/                    # Components ONLY
├── package.json
│   ├── exports: { ".": "./dist/index.js" }  # NO "./theme" export
│   ├── peerDependencies:
│   │   └── "@dbarrett24/theme-system": ">=1"  # Required by consumer
│   └── devDependencies:
│       └── "@dbarrett24/theme-system": "workspace:*"  # Build-time types
└── NO src/theme/ directory

apps/docs/.storybook/global.css
@import '@dbarrett24/theme-system/css/BasketballTraining.css';
@import '@dbarrett24/theme-system/css/ProfessionalBrand.css';
```

**OLD ARCHITECTURE** (Pre-DS-15b, DEPRECATED):
```
❌ brand-libraries/basketball-training-ui/src/theme/styles.css  # DELETED
❌ package.json exports: { "./theme": "./dist/theme/styles.css" }  # REMOVED
```

## Preferred Approach: Class-Based Selectors

This project uses class-based CSS selectors for theme switching (Hammer UI pattern).

### Generated CSS Structure

**Generated CSS files** (in `theme-system/dist/css/*.css`):
```css
/* Primary: Class-based selector for theme switching */
.brand-basketball {
    --color-primary-500: 255 107 53;
    --color-background-primary: 255 255 255;
    /* ... all theme variables */
}

/* Fallback: :root for standalone usage */
:root {
    --color-primary-500: 255 107 53;
    --color-background-primary: 255 255 255;
    /* ... same variables for backward compatibility */
}
```

### Why Class-Based Over Data Attributes

**Class-based** (✅ Preferred):
```html
<div class="brand-basketball">
  <Button>Click me</Button>
</div>
```

**Data attribute** (❌ Avoid):
```html
<div data-theme="basketball">
  <Button>Click me</Button>
</div>
```

**Rationale**:
- Matches Hammer UI architecture
- Higher CSS specificity than :root
- Simpler selectors (no attribute selectors needed)
- Better performance (class matching is faster)

### Backward Compatibility

Always maintain :root fallback when adding class-based selectors:

```css
/* New: Class-based for theme switching */
.brand-basketball {
    --interactive-primary: #ff6b35;
}

/* Existing: Keep for backward compatibility */
:root {
    --interactive-primary: #ff6b35;
}
```

This ensures existing consumers continue working without changes.

## Tailwind Integration

CSS variables are mapped in theme-system:

```typescript
// theme-system/src/theme.ts
export const baseTheme = {
    colors: {
        'interactive-primary': 'var(--interactive-primary)',
        // ...
    },
};
```

Components use Tailwind classes:
```tsx
<button className="bg-interactive-primary">
  {/* Background color comes from CSS variable */}
</button>
```

## Adding New Brand Themes

**NEW PROCESS** (DS-15b+):

1. **Create TypeScript brand definition** in `theme-system/src/themes/NewBrand.ts`:
   ```typescript
   import { colorStepArrayToObject, generateNormalColorSteps, generateSurfaceColorSteps } from '../utils/color';
   import { wrapVar } from '../utils/wrapVar';
   import { colorSurface50, colorSurface200, /* ... */ } from '../tailwind/cssVars';
   
   export const coreColors = {
       brandPrimary: colorStepArrayToObject(generateNormalColorSteps('#YOUR_COLOR')),
       neutral: colorStepArrayToObject(generateSurfaceColorSteps('#GRAY', true)),
       // ... 6-8 core colors total
   };
   
   export const colorAliases = {
       primary: coreColors.brandPrimary,  // Maps to 10 shades
       surface: coreColors.neutral,
       // ... 8 aliases
   } satisfies ColorAliasesObject;
   
   export const nonColorVariables = {
       '--color-background-primary': wrapVar(colorSurface50),
       '--color-background-disabled': wrapVar(colorSurface200),
       // ... semantic tokens reference palette
   } satisfies Record<NonColorCSSVariables, string>;
   ```

2. **Update `themes/brands.ts`**:
   ```typescript
   export type Brands = 'BasketballTraining' | 'ProfessionalBrand' | 'Default' | 'NewBrand';
   export const brandsToCSS: Record<Brands, string> = {
       // ...
       NewBrand: 'brand-newbrand',
   };
   ```

3. **Update `tsup.config.ts` onSuccess hook**:
   ```typescript
   import { nonColorVariables as NewBrand, colorAliases as NewBrandAliases } from './src/themes/NewBrand';
   
   // In onSuccess:
   writeToCSSFile(
       generateCSSVars({ 
           ...NewBrand, 
           ...makeColorCSSVarsFromObject(NewBrandAliases) 
       }, 'brand-newbrand'),
       'dist/css/NewBrand.css'
   );
   ```

4. **Update `package.json` exports**:
   ```json
   {
     "exports": {
       "./css/NewBrand.css": "./dist/css/NewBrand.css"
     }
   }
   ```

5. **Build**: `pnpm build` → generates `dist/css/NewBrand.css` (376 lines)

6. **Use in app**: 
   ```css
   @import '@dbarrett24/theme-system/css/NewBrand.css';
   ```

**Time**: ~30 minutes (vs 2-3 hours manual CSS with old approach)

**Pattern**: See `.cursor/rules/architecture/build-time-generation.mdc` for complete guide

### Build-Time CSS Generation

Theme-system uses tsup's `onSuccess` hook to generate CSS files from TypeScript:

```typescript
// tsup.config.ts
export default defineConfig({
    entry: ['src/index.ts', /* ... */],
    format: ['esm', 'cjs'],
    onSuccess: async () => {
        console.log('✅ Generating theme CSS files...');
        
        // Import brand definitions
        const { nonColorVariables: Basketball, colorAliases: BasketballAliases } = 
            await import('./dist/themes/BasketballTraining.mjs');
        
        // Generate CSS
        writeToCSSFile(
            generateCSSVars({ 
                ...Basketball, 
                ...makeColorCSSVarsFromObject(BasketballAliases) 
            }, 'brand-basketball'),
            'dist/css/BasketballTraining.css'
        );
        
        console.log('✅ Generated theme CSS files in dist/css/');
    },
});
```

**Pattern**: See `.cursor/rules/architecture/build-time-generation.mdc` for complete guide

## Testing Theme Changes

After modifying theme definitions:
1. Rebuild theme-system: `pnpm --filter @dbarrett24/theme-system build`
2. Verify CSS generated: `ls shared-configs/theme-system/dist/css/`
3. Restart dev servers/Storybook
4. Hard refresh browser (Cmd+Shift+R)
5. Verify all CSS variables update correctly

## Theme Implementation Validation Checklist

After modifying theme CSS or adding new brands, validate using this checklist:

### Build-Time Checks

- [ ] `pnpm build` succeeds with no PostCSS errors
- [ ] No `@tailwind` directives in brand CSS files
- [ ] All `@import` statements come before `@tailwind`
- [ ] Brand package exports `./theme` path in `package.json`
- [ ] Theme-system rebuilt if `theme.ts` modified

### Browser DevTools Checks

Open Storybook → ThemeInfrastructure stories → Open DevTools:

**1. CSS Variables Exist**:
- Right-click element → Inspect → Computed tab
- Search for `--color-` → Verify all variables present
- Check values match brand expectations

**2. No Duplicate CSS Rules**:
- Inspect any heading → Styles tab
- Search for `.hui-text-` classes
- Should appear ONCE (not twice with strikethrough)

**3. Colors Apply Correctly**:
- Background colors visible
- Text colors readable
- Border colors showing
- Focus rings working (Tab through buttons)

**4. Typography Classes Work**:
- `.hui-text-h1` through `.hui-text-h6` render different sizes
- Font families apply (`--font-family-primary`, `--font-family-secondary`)
- Font weights use variables (`--font-weight-h1`, etc.)

**5. Semantic Tokens Work**:
- `rounded-button` applies correct border radius (8px)
- `rounded-input` applies correct border radius (6px)
- `font-primary` uses `--font-family-primary`
- `font-secondary` uses `--font-family-secondary`

**6. Spacing Scale Correct**:
- `px-sm` = 16px (not 12px)
- `px-md` = 24px (not 16px)
- `px-lg` = 32px (not 24px)

### Common Failures and Fixes

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| No colors appear | CSS variable name mismatch | Check `--color-*` prefix matches `theme.ts` |
| Duplicate rules in DevTools | `@tailwind` in brand files | Remove from brand CSS |
| PostCSS build error | Import order | Move `@import` above `@tailwind` |
| Focus rings missing | Plugin not loaded | Add `themePlugin` to app's `tailwind.config.js` |
| Wrong spacing values | Not rebuilt | `cd theme-system && pnpm build` |
